---
import AdminLayout from "../../layouts/AdminLayout.astro";
const sessionCookie = Astro.cookies.get("session");
const isLoggedIn = sessionCookie?.value === "unsecure_session";

let error = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action") as string;

  switch (action) {
    case "login":
      const username = formData.get("username") as string;
      const password = formData.get("password") as string;

      if (
        username === import.meta.env.ADMIN_USERNAME &&
        password === import.meta.env.ADMIN_PASSWORD
      ) {
        Astro.cookies.set("session", "unsecure_session", {
          path: "/",
          httpOnly: true,
          maxAge: 60 * 60 * 24,
        });
        return Astro.redirect("/admin");
      } else {
        error = "Invalid credentials";
      }

      break;

    case "logout":
      Astro.cookies.delete("session", { path: "/" });
      return Astro.redirect("/admin");
  }
}
---

<AdminLayout>
  {
    !isLoggedIn ? (
      <div>
        <h1>Admin Panel</h1>
        {error && <div>{error}</div>}
        <form method="POST">
          <input type="hidden" name="action" value="login" />
          <div>
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required />
          </div>
          <div>
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required />
          </div>
          <button type="submit">Log in</button>
        </form>
      </div>
    ) : (
      <div>
        <form method="POST">
          <input type="hidden" name="action" value="logout" />
          <button type="submit">Log out</button>
        </form>
        Logged in
      </div>
    )
  }
</AdminLayout>
